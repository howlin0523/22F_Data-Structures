# 电梯模拟

## 问题描述

设计一个电梯模拟系统。这是一个离散的模拟程序，因为电梯系统是乘客和电梯等“活动体”构成的集合，虽然他们彼此交互作用，但他们的行为是基本独立的。在离散的模拟中，以模拟时钟决定每个活动体的动作发生的时刻和顺序，系统在某个模拟瞬间处理有 待完成的各种事情，然后把模拟时钟推进到某个动作预定要发生的下一个时刻

## 基本要求

1. 模拟某校五层教学楼的电梯系统。该楼有一个自动电梯，能在每层停留。五个楼层由下至上依次称为地下层、第一层、第二层、第三层和第四层，其中第一层是大楼的进出层，即是电梯的“本垒层”，电梯“空闲”时，将来到该层候命。
2. 乘客可随机地进出于任何层。对每个人来说，他有一个能容忍的最长等待时间，一旦等候电梯时间过长，他将放弃。
3. 模拟时钟从0开始， 时间单位位0.1秒。人和电梯的各种动作均要耗费一定的时间单位（简记为$t$），比如：
   有人进出时，电梯每隔 40厂测试一次，若无人进出，则关门；
   关门和开门各需要20$t;
   $每个人进出电梯均需要 $25t$;
    如果电梯在某层静止时间超过 $300t$，则驶回 1 层候命。
4. 按时序显示系统状态的变化过程:发生的全部人和电梯的动作序列

## 测试数据

模拟时钟 Time 的初值为 0,终值可在 500〜10000 范围内逐步增加。

## 实现提示

1. 楼层由下至上依次编号为$0,1,2,3,4$  每层有要求Up（上）和Down（下）的两个按钮，对应 10 个变量CallUp[0.. 4]，和CallDown[0.. 4]。电梯内5个目标层按钮对应变量CallCar[0.. 4]。有人按下某个按钮时，相应的变量就置为1,一旦满足要求后，电梯就把变量清为0
2. 电梯处于三种状态之一 GoingUp(上行）、GoingDown(下行)和Idle(停候) 
3. 用变量 Time 表示模拟时钟, 初值为 0 , 时间单位 $(t)$ 为 $0.1$ 秒。其他重要的变量 有:
   1. Floor-电梯的当前位置 (楼层);
    D1-值为 0 , 除非人们正在进入和离开电梯;
    D2-值为 0 , 如果电梯已经在某层停候 $300 t$ 以上;
    D3-值为 0 ,除非电梯门正开着又无人进出电梯;
    State-电梯的当前状态 (GoingUp, GoingDown, Idle)。
    系统初始时, Floor $=1, D 1=D 2=$ D3 $=0$, State $=$ Idle。
4. 每个人从进入系统到离开称为该人在系统中的存在周期。在此周期内, 他有 6 种 可能发生的动作:
**M1.** [进入系统, 为下一人的出现作准备]产生以下数值:
InFloor-该人进入哪层楼;
OutFloor-他要去哪层楼;
GiveupTime-一他能容忍的等候时间;
InterTime-下一人出现的时间间隔, 据此系统预置下一人进入系统的时刻。
**M2.** [按电钮并等候]此时应对以下不同情况作不同的处理:
(1) Floor $=$ InFloor 且电梯的下一个活动是 $\mathrm{E} 6$ (电梯在本层, 但正在关门);
(2) Floor $=$ InFloor 且 $\mathrm{D} 3 \neq 0$ (电梯在本层, 正有人进出);
(3) 其他情况, 可能 $\mathrm{D} 2=0$ 或电梯处于活动 $\mathrm{E} 1$ (在 1 层停候)。
**M3.** [进入排队]在等候队列 Queue[InFloor]末尾揷入该人, 并预置在 Giveup Time 个 $t$ 之后, 他若仍在队列中将实施动作 M4。

**M4.** [放弃] 如果 Floor $\neq$ InFloor 或 D1 $=0$, 则从 Queue[InFloor]和系统删除该人。如 果 Floor = InFloor 且 $D 1 \neq 0$, 他就继续等候 (他知道马上就可进入电梯)。

**M5.** [进入电梯]从 Queue[InFloor]删除该人, 并把他揷入到 Elevator (电梯) 栈中。置 CallCar [OutFloor]为 1 。
**M6.** [ 离去]从 Elevator 和系统删除该人。
5. 电梯的活动有 9 种:
**E1.** [在 1 层停候]若有人按下一个按钮, 则调用 Controler 将电梯转入活动 $\mathrm{E} 3$ 或 E6。

**E2.** [要改变状态?]如果电梯处于 GoingUp(或 GoingDown) 状态, 但该方向的楼层却 无人等待, 则要看反方向楼层是否有人等候, 而决定置 State 为 GoingDown(或 GoingUp) 还是 Idle。

**E3.** [开门]置 D1 和 D2 为非 0 值, 预置 300 个 $t$ 后启动活动 $\mathrm{E} 9$ 和 76 个 $t$ 后启动 $\mathrm{E} 5$, 然后预置 20 个 $t$ 后转到 $\mathrm{E} 4$ 。

**E4.** [让人出入]如果 Elevator 不空且有人的 OutFloor =Floor, 则按进入的倒序每隔 25 个 $t$ 让这类人立即转到他们的动作 M6。Elevator 中不再有要离开的人时, 如果 Queue [Floor]不空, 则以 25 个 $t$ 的速度让他们依次转到 M5。Queue[Floor]空时, 置 D1 为 0,D3$\neq 0$, 而且等候某个其他活动的到来。
**E5.** [关门]每隔 40 个 $t$ 检査 D1, 直到是 $\mathrm{D} 1=0$ (若 D $1 \neq 0$, 则仍有人出入)。置 D3 为 0 并预置电梯再 20 个 $t$ 后启动活动 E6＼cjkstart再关门期间, 若有人到来, 则如 $\mathrm{M} 2$ 所述, 门再次 打开）。

**E6.** [准备移动]置 CallCar [Floor] 为 0 , 而且若 State $\neq$ GoingDown, 则置 CallUp [Floor]为 0 ; 若 State $\neq$ GoingUp, 则置 CallDown[Floor]为 0 。调用 Controler 函数。
如果 State =Idle, 则即使已经执行了 Controler, 也转到 $\mathrm{E} 1$ 。否则, 如果 $\mathrm{D} 2 \neq 0$, 则取 消电梯活动 $\mathrm{E}$ 9。最后, 如果 State =GoingUp}, 则预置 15 个 $t$ 后 (电梯加速) 转到 $\mathrm{E} 7$; 如果 State = GoingDown, 则预置 15 个 $t$ 后 (电梯加速) 转到 $\mathrm{E} 8$ 。

**E7.** [上升一层]置 Floor 加 1 并等候 51 个 $t$ 。如果现在 CallCar [Floor] $=1$ 或 CallUp $[$ Floor $]=1$, 或者如果 ((Floor $=1$ 或 CallDown [Floor $]=1$ ) 且 CallUp $[\mathrm{j}]=$ CallDown $[\mathrm{j}]=$ CallCar $[\mathrm{j}]=0$ 对于所有 $j>$ Floor), 则预置. 14 个 $t$ 后 (减速) 转到 E2; 否则 重复 E7。

**E8.** [下降一层]除了方向相反之外,与 $\mathrm{E} 7$ 类似, 但那里的 51 和 14 个 $t$, 此时分别改 为 61 和 23 个 $t$ (电梯下降比上升慢)。

**E9.** [置不活动指示器]置 D2 为 0 并调用 Controler 函数 (E9 是由 $\mathrm{E} 3$ 预置的, 但几乎 总是被 E6取消了)。
6. 当电梯须对下一个方向作出判定时,便在若干临界时刻调用 Controler 函数。该 函数有以下要点:
**C1.** [需要判断?]若 State $\neq$ Idle, 则返回。

**C2.** [应该开门?]如果电梯处于 $\mathrm{E} 1$ 且 CallUp[1], CallDown[1]或 CallCar[1]非 0 , 则 预置 20 个 $t$ 后启动 $\mathrm{E} 3$, 并返回。

**C3.** [有按钮按下?]找最小的 $j \neq F l o o r$, 使得 CallUp[j],CallDown[j]或 CallCar $[\mathrm{j}]$ 非 0 , 并转到 C4。但如果不存在这样的 $j$, 那么, 如果 Controler 正为 E6 所调用, 则置 $j$ 为 1 , 否则返回。

**C4.** [置 State] 如果 Floor $>j$, 则置 State 为 GoingDown ; 如果 Floor $<j$, 则置 State 为 GoingUp。

**C5.** [电梯静止?]如果电梯处于 $\mathrm{E} 1$ 而且 $j \neq 1$, 则预置 20 个 $t$ 后启动 $\mathrm{E} 6$ 。返回。
7. 由上可见, 关键是按时序管理系统中所有乘客和电梯的动作设计合适的数据结 构。

## 选作内容

1. 增加电梯数量, 模拟多梯系统。
2. 某高校的一座 30 层住宅楼有三部自动电梯,每梯最多载客 15 人。大楼每层 8 户, 每户平均 3.5 人, 每天早晨平均每户有 3 人必须在 7 时之前离开大楼去上班或上学。 模拟该电梯系统, 并分析分别在一梯、二梯和三梯运行情况下,下楼高峰期间各层的住户 应提前多少时间候梯下楼? 研究多梯运行最佳策略。
